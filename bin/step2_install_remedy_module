#! /bin/bash
#
echo "Installing Puppet CVE-2011-3872 CA Migration Module ..."
cd /opt/puppet/share/puppet/modules
puppet-module clean
puppet-module install /vagrant/modules/cve20113872/pkg/puppetlabs-cve20113872-0.0.1.tar.gz --force

if grep -q 'include cve20113872' /etc/puppetlabs/puppet/manifests/site.pp; then
  echo "site.pp already includes class cve20113872 ... (Nothing to do)"
else
  echo "Configuring site.pp ..."
  perl -p -l -i.cve_module -e 's/^(\s*)(node\s+default\s+{\s*)$/$1$2\n$1  # CVE-2011-3872 CA Migration Class\n$1  include cve20113872/' \
    /etc/puppetlabs/puppet/manifests/site.pp
fi

echo "Done ..."
